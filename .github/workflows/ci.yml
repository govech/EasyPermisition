name: Android CI/CD

permissions:
  contents: write

on:
  push:
    branches: [ main, master, develop ]
    tags:
      - "v*"   # æ‰“ tag æ—¶è§¦å‘ Release
  pull_request:
    branches: [ main, master, develop ]

jobs:

  # ===============================================
  # 1ï¸âƒ£ æ—¥å¸¸ CIï¼šå•å…ƒæµ‹è¯• + Lint + Debug APK + Library AAR
  # ===============================================
  ci:
    name: CI - Test & Build Debug/AAR
    runs-on: ubuntu-latest

    steps:
      # æ‹‰å–ä»£ç 
      - uses: actions/checkout@v4

      # JDK 17
      - uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      # ç¼“å­˜ Gradle
      - uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # æˆæƒ gradlew
      - run: chmod +x gradlew

      # å•å…ƒæµ‹è¯•
      - name: Run Unit Tests
        run: ./gradlew test
        continue-on-error: true

      # Lint æ£€æŸ¥
      - name: Run Lint
        run: ./gradlew lint
        continue-on-error: true

      # æ„å»º Debug APK
      - name: Build Debug APK
        run: ./gradlew assembleDebug

      # æ„å»º Library AARï¼ˆå¦‚æœæœ‰ library æ¨¡å—ï¼‰
      - name: Build Library AAR
        run: ./gradlew assembleRelease :permission-core:assembleRelease :permission-coroutine:assembleRelease
        continue-on-error: true

      # ---------- 2. ç”Ÿæˆç‰ˆæœ¬å· ----------
      - name: create_version
        id: get_version
        run: |
          VERSION="$(date +%Y%m%d).${{ github.run_number }}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "æœ¬æ¬¡æ„å»ºç‰ˆæœ¬ => $VERSION"

      - name: Generate performance report
        run: |
          echo "# æ€§èƒ½æŠ¥å‘Š" > performance-report.md
          echo "ç‰ˆæœ¬: ${{ steps.get_version.outputs.VERSION }}" >> performance-report.md
          echo "æ„å»ºæ—¶é—´: $(date)" >> performance-report.md
          echo "" >> performance-report.md
          echo "## åŒ…å¤§å°" >> performance-report.md
          echo "- æ ¸å¿ƒåº“: $(du -h permission-core/build/outputs/aar/permission-core-release.aar | cut -f1)" >> performance-report.md
          echo "- åç¨‹åº“: $(du -h permission-coroutine/build/outputs/aar/permission-coroutine-release.aar | cut -f1)" >> performance-report.md
          echo "- æ¼”ç¤ºåº”ç”¨: $(du -h demo/build/outputs/apk/release/demo-release-unsigned.apk | cut -f1)" >> performance-report.md

      # ä¸Šä¼  Debug APK / AAR äº§ç‰©
      - name: Upload CI Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ci-artifacts
          path: |
            app/build/outputs/apk/debug/*.apk
            **/build/outputs/aar/*.aar
          if-no-files-found: ignore

  # =================================================================================================
  # 2ï¸âƒ£ æ‰“ Tag æ—¶è‡ªåŠ¨å‘å¸ƒç­¾å Release APK + AAR    (æ³¨æ„ï¼šå¦‚æœæœ‰ keystore secretsï¼Œä¼šè‡ªåŠ¨ç­¾åï¼Œå¦åˆ™ä¸º unsigned)
  # =================================================================================================
  release:
    name: Release - Optional Signed APK + AAR
    runs-on: ubuntu-latest
    needs: [ ci ]
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      # ä¸‹è½½ CI äº§ç‰©
      - uses: actions/download-artifact@v4
        with:
          name: ci-artifacts
          path: build-artifacts

      # å¦‚æœæœ‰ keystore secretsï¼Œå°±æ¢å¤ keystore
      - name: Restore Keystore (if available)
        run: |
          if [ -n "${{ secrets.KEYSTORE_FILE }}" ]; then
            echo "${{ secrets.KEYSTORE_FILE }}" | base64 --decode > release.jks
          else
            echo "No keystore secret found, skipping..."
          fi

      # æ„å»º Release APK + AARï¼ˆå·²ä¿®å¤ç­¾å & fiï¼‰
      - name: Build Release APK + AAR
        run: |
          chmod +x ./gradlew 
          if [ -f release.jks ]; then
            echo "Signing Release APK with keystore..."
            ./gradlew assembleRelease :permission-core:assembleRelease :permission-coroutine:assembleRelease\
              -PRELEASE_STORE_FILE=release.jks \
              -PRELEASE_STORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }} \
              -PRELEASE_KEY_ALIAS=${{ secrets.KEY_ALIAS }} \
              -PRELEASE_KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}
          else
            echo "No keystore found, building unsigned release..."
            ./gradlew assembleRelease :permission-core:assembleRelease :permission-coroutine:assembleRelease
          fi

      # ä¸Šä¼  Release
      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "Release ${{ github.ref_name }}"
          tag_name: ${{ github.ref_name }}
          body: |
            ğŸš€ è‡ªåŠ¨å‘å¸ƒç‰ˆæœ¬ï¼š**${{ github.ref_name }}**
            - æ„å»ºå·: $(date +%Y%m%d).${{ github.run_number }}
            - æ¥æºåˆ†æ”¯: ${{ github.ref_name }}
            - æ„å»ºæ—¶é—´: ${{ github.run_started_at }}
          files: |
            build-artifacts/**/*.apk
            build-artifacts/**/*.aar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

