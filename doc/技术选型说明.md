# Android权限请求框架 - 技术选型说明

## 核心技术选型

### 1. 权限请求API选择

#### ✅ 选择：Activity Result API
- **原因**：
  - Google官方推荐的现代化权限请求方式
  - 类型安全，编译时检查
  - 生命周期感知，自动处理配置变更
  - 支持Fragment和Activity
  - 向前兼容性好

- **具体使用**：
  - `ActivityResultContracts.RequestPermission`（单权限）
  - `ActivityResultContracts.RequestMultiplePermissions`（多权限）
  - 自定义`ActivityResultContract`扩展

#### ❌ 不选择：传统requestPermissions方式
- 需要手动处理onRequestPermissionsResult
- 容易出现内存泄漏
- 代码冗余，不够优雅

### 2. 依赖管理策略

#### ✅ 零依赖设计
- **唯一依赖**：`androidx.activity:activity-ktx ≥1.7`
  - 提供Activity Result API支持
  - 现代Android项目的标准依赖
  - 体积小，兼容性好

#### ❌ 不依赖的库
- **RxJava**：避免引入响应式编程复杂性
- **Kotlin-Coroutine**：保持核心模块轻量，但提供扩展模块
- **其他权限库**：避免功能重复和冲突

### 3. 编程语言支持

#### ✅ Kotlin First设计
- 主要API使用Kotlin编写
- 利用Kotlin的语言特性（扩展函数、DSL等）
- 提供类型安全的API

#### ✅ Java兼容
- 使用`@JvmStatic`、`@JvmOverloads`注解
- 提供Java友好的静态方法
- 避免Kotlin特有语法在Java中的使用困难

### 4. 架构模式选择

#### ✅ 建造者模式（Builder Pattern）
```kotlin
PermissionManager.with(this)
    .permissions(Manifest.permission.CAMERA)
    .rationale("需要相机权限来拍照")
    .onGranted { /* 授权成功 */ }
    .onDenied { /* 被拒绝 */ }
    .request()
```

#### ✅ 单例模式（Singleton Pattern）
- `PermissionManager`作为全局入口
- 管理权限请求的生命周期
- 提供全局配置能力

### 5. 状态管理

#### ✅ 枚举状态管理
```kotlin
enum class PermissionState {
    GRANTED,        // 已授权
    DENIED,         // 首次拒绝
    PERMANENTLY_DENIED  // 永久拒绝
}
```

### 6. 扩展性设计

#### ✅ 接口导向设计
- `PermissionCallback`：权限回调接口
- `RationaleHandler`：权限解释处理接口
- `PermissionInterceptor`：权限拦截器接口

#### ✅ SPI（Service Provider Interface）
- 支持第三方扩展
- 埋点、日志、灰度等功能可插拔

### 7. 协程支持策略

#### ✅ 可选扩展模块
- 核心模块不依赖协程
- 单独的`permission-coroutine`模块
- 提供`suspend`函数和`Flow`支持

```kotlin
// 扩展模块提供
suspend fun requestPermission(permission: String): Boolean
fun observePermissionState(permission: String): Flow<PermissionState>
```

### 8. 测试策略

#### ✅ 多层次测试
- **单元测试**：核心逻辑测试，使用JUnit + Mockito
- **集成测试**：权限请求流程测试，使用Espresso
- **兼容性测试**：多版本Android设备测试

#### ✅ 测试覆盖率
- 目标：≥80%代码覆盖率
- 工具：JaCoCo生成覆盖率报告

### 9. 混淆和优化

#### ✅ ProGuard/R8支持
- 提供专门的混淆规则文件
- 保留必要的公共API
- 优化包体积

#### ✅ 性能优化
- 避免反射调用
- 懒加载初始化
- 内存泄漏预防

### 10. 版本兼容策略

#### ✅ 最低支持版本
- **Android 6.0（API 23）**：运行时权限的起始版本
- **编译版本**：最新稳定版Android SDK
- **目标版本**：最新稳定版Android

#### ✅ 新版本适配
- Android 14+新权限特性
- 向下兼容处理
- 版本检查和降级处理

## 技术选型总结

| 技术点 | 选择 | 原因 |
|--------|------|------|
| 权限API | Activity Result API | 官方推荐，类型安全，生命周期感知 |
| 核心语言 | Kotlin | 现代化，简洁，类型安全 |
| Java支持 | 兼容层 | 扩大使用范围，降低迁移成本 |
| 依赖策略 | 零依赖 | 减少冲突，降低体积 |
| 架构模式 | Builder + Singleton | 易用性和可维护性平衡 |
| 协程支持 | 可选扩展 | 保持核心轻量，满足高级需求 |
| 测试策略 | 多层次测试 | 保证质量和稳定性 |